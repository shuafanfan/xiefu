<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>发布最新款</title>
    <meta name="viewport" content="initial-scale=1, maximum-scale=1">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <link rel="stylesheet" href="__TMPL__Public/css/light7.min.css">
    <link rel="stylesheet" href="__TMPL__Public/css/light7-swiper.min.css">

    <link rel="stylesheet" href="__TMPL__Public/css/style.css">
    <link rel="stylesheet" href="__TMPL__Public/css/common.css">

    <link rel="stylesheet" href="__TMPL__Public///at.alicdn.com/t/font_376445_pyo12qn6e21vpldi.css">

 <link rel="stylesheet" href="__TMPL__Public/css/webuploader.css">
 

 <!--   <link rel="stylesheet" href="//at.alicdn.com/t/font_376445_4l9rsah7c63qsemi.css">
-->

</head>

<body>

<!-- page 容器 -->
<div class="page page-current">
    <!-- 这里是标题栏栏 -->
    <header class="bar bar-nav">
        <button class="button button-link button-nav pull-left">
            <span class="icon icon-zuo"></span>
        </button>
        <button class="button button-link button-nav pull-right">
            <a href="" class="color_white" id="submit">发布</a>
        </button>

        <h1 class="title">
            发布最新款
        </h1>

    </header>
    <!-- 这里是标题栏end -->

    <!-- 底部工具栏 -->
    <tc_include file="Public:bottom" />
    <!-- 底部工具栏 end-->

    <!-- 这里是页面内容区 -->
    <div class="content ">
        <!--   这里是 搜索面板-->
        <div class="content-block reportgoods">

            <div class="xingzhi" id="xingzhi">
                <span >
                  全部
                </span>
                <ul>
                    <li><a href="#" data="1">个人</a></li>
                    <li><a href="#" data="2">商家</a></li>

                </ul>
            </div>

            <div class="xingzhi xingzhi_toggle" id="reportgood_toggle" style="border: none">
              <span>
                 全部
              </span>
                <ul class="category_hide">
                 <volist name="brand" id="vo">
                    <li><a href="#" data="{$vo.name}">{$vo.name}</a></li>
                </volist>
                </ul>

                   <span class="zhankai">
                   <span class="zhankai_zi"></span>
                    <div class="yousanjiao" id="sanjiao">
                     </div>

                    <div class="shangsanjiao" id="">

                     </div>
                </span>

            </div>

        </div>

        <div class=" form_all">

        <div class="list-block form_fabu">
            <ul>
                <!-- Text inputs -->
                <li>
                    <div class="item-content">
                        <div class="item-inner">
                            <div class="item-title label">标题</div>
                            <div class="item-input">
                                <input type="text" placeholder="选填" maxlength="8" id="title">
                            </div>
                        </div>
                    </div>
                </li>
                <li>
                    <div class="item-content">
                        <div class="item-inner">
                            <div class="item-title label">尺码</div>
                            <div class="item-input">
                                <input type="text" placeholder="选填" maxlength="5" id="size">
                            </div>
                        </div>
                    </div>
                </li>
        </ul>
        </div>

                                   <!--  图片上传 Begin  -->
				                  <div class="list-block form_fabu">
					                  <div class="row add-pig">
						
						            <div class="col-33 " id="img1" data="">
							          <span class="iconfont icon-jiahao"></span>
						           </div>
						
					                </div>
				                  </div>
				                       <input type="hidden" value="" name="smeta" id="smeta" />
				                   <!--  图片上传 End  -->
        </div>
    </div>



</div>


<script type="text/javascript" src="__TMPL__Public/js/jquery.min.js" charset="utf-8"></script>
<script type="text/javascript" src="__TMPL__Public/js/light7.min.js" charset="utf-8"></script>
<script type="text/javascript" src="__TMPL__Public/js/light7-swiper.min.js"></script>
<script type="text/javascript" src="__TMPL__Public/js/conmon.js"></script>

<script type="text/javascript" src="__TMPL__Public/js/webuploader.js"></script>

<!-- 图片上传 Begin-->
<script>
	$(function() {webupload_pic(1);});
	
	function webupload_pic(i) {
			
			var next_i = Number(i)+1;			
			var maxfileNum = 9;
			var maxsize = 5000;		
			var target_id = '#img' + i;
			
			
				
			var uploader = WebUploader.create({
				multiple: false,
				auto: true,
				swf: "__TMPL__Public/js/webuploader/Uploader.swf ",
				server: "/api/index.php/home/Rest/upload",
				pick: {
					id: target_id,
					innerHTML: ''
				},
				accept: {
					title: 'Images',
					extensions: 'gif,jpg,jpeg,png',
					mimeTypes: 'image/*'
				},

				compress: {
					width: 640,
					height: 640,
					// 图片质量，只有type为`image/jpeg`的时候才有效。
					quality: 95,
					// 是否允许放大，如果想要生成小图的时候不失真，此选项应该设置为false.
					allowMagnify: false,
					// 是否允许裁剪。
					crop: true,
					// 是否保留头部meta信息。
					preserveHeaders: true,
					// 如果发现压缩后文件大小比原来还大，则使用原来图片
					// 此属性可能会影响图片自动纠正功能
					noCompressIfLarger: false,
					// 单位字节，如果图片大小小于此值，不会采用压缩。
					compressSize: 0
				},
				fileSingleSizeLimit: maxsize * 1024 * 1024,
				fileNumLimit:1,
				duplicate: false,
				formData: {
					code: 'identity',
				}
			});
			
			
			//上传时
			uploader.on('fileQueued', function(file) {								
				console.log('  上传时 ');
				$(target_id).html("<span style='font-size: 0.6rem;'>0 %</span>");

			});
			//上传中
			uploader.on('uploadProgress', function(file, percentage) {
				console.log('  上传中');
				var percent = parseFloat(percentage * 100);
				$(target_id).find("span").text(percent + "%");
			});

			uploader.on('uploadBeforeSend', function(block, data) {
				data.maxsize = maxsize;
			});

			//上传成功后
			uploader.on('uploadSuccess', function(file, response) {
				console.log('  上传成功后'+next_i);
				console.log(response);		
				
							
				/* 如果图片上传未超过限制数量 生成上传按钮 */
				var picnum = $('.add-pig').children('div').length;
				if( picnum < maxfileNum){					
					if($("#img"+next_i).length==0){
						$(".add-pig").append('<div class="col-33 " id="img'+next_i+'" data=""><span class="iconfont icon-jiahao"></span></div>');
					}						
					webupload_pic(next_i);
				}
								
				$(target_id).find(".img_common").remove();
				$(target_id).find(".iconfont").remove();
				
				if(response.code == 1) {
					$(target_id).html("");
						/* 添加 删除 按钮 begin ………… */
					$(target_id).prepend("<i class='iconfont icon-close' data='"+response.data['url']+"' xu='"+i+"'></i><img class='img_common ' width='100' height='100' src=" + response.data['url'] + " data-pic=" + response.data['filename'] + "  />");
					var durl   = $(target_id).attr("data");
					var oldurl = $("#smeta").val();
					var newurl = oldurl + "," + response.data['url'];
					$(target_id).attr("data", response.data['url']);
					$("#smeta").val(newurl);
					
					/* 添加 删除 按钮 End ………… */
					console.log(' durl = ' + durl);
					console.log(' oldurl = ' + oldurl);
					console.log(' newurl = ' + $("#smeta").val());
					console.log('……………………END ………………');

				} else {
					$.alert("上传失败！请重试。");
				}

			});

			uploader.on('uploadError', function(file, reason) {
				console.log('  上传失败 ………………');
				$.alert("上传失败！请重试。");

			});


	}

	/*   Upload  end */

	$(document).on('click', '.icon-close', function() {

		var durl = $(this).attr("data");
		var i    = $(this).attr("xu");
		$.alert('确实要删除这张图片吗？', function () {

			var oldurl = $("#smeta").val();
			var newurl = oldurl.replace(durl, '');
			$("#smeta").val(newurl);
			$("#img" + i).remove();
			/* 如果图片上传未超过限制数量 生成上传按钮 */
			var picnum = $('.add-pig').children('div').length;
			if( picnum < 9){
				
				if($("#img"+i).length==0){
					$(".add-pig").append('<div class="col-33 " id="img'+i+'" data=""><span class="iconfont icon-jiahao"></span></div>');
				}						
				webupload_pic(i);
				
			}
				
			console.log(' durl = ' + durl);
			console.log(' oldurl = ' + oldurl);
			console.log(' newurl = ' + $("#smeta").val());

		});


	});
</script>

<!-- 图片上传 End -->
<script>
    $("#submit").click(function(){
    	var brand=$('#reportgood_toggle').find('.on').attr('data');
        var title=$('#title').val();
        var size=$('#size').val();

        $.ajax({
            type: "POST",
            url: "{:U('report/reportgoods/donewstyle')}",
            data:  {'brand':brand,'title':title,'size':size},
            async: false,
            success: function(data) {


                if(data['status']=='1'){
                    $.alert("发布成功",function(){
                        window.location.href="{:U('report/reportgoods/newrecord')}";
                    });


                }
                if(data['status']=='0'){
                    $.alert("发布失败");

                }
                if(data['status']=='2'){
                    $.alert(data['msg']);

                }

            },
            error:function(){
                $.alert("发布失败");
            }
        });
    })

</script>
</body>
</html>
